{"version":3,"sources":["Client.js"],"names":["fetchWithNetworkError","require","module","exports","opts","_reportError","bind","_headers","client","createAssembly","templateId","params","fields","signature","expectedFiles","data","FormData","append","JSON","stringify","Object","keys","forEach","key","url","service","method","headers","body","then","response","json","assembly","error","Error","details","message","assembly_id","catch","err","type","reserveFile","file","size","encodeURIComponent","assembly_ssl_url","addFile","uploadURL","Promise","reject","uploadUrl","filename","name","fieldname","qs","cancelAssembly","getAssemblyStatus","submitError","endpoint","instance","agent","navigator","userAgent","errorReporting","_"],"mappings":"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","sourcesContent":["const fetchWithNetworkError = require('@uppy/utils/lib/fetchWithNetworkError')\n\n/**\n * A Barebones HTTP API client for Transloadit.\n */\nmodule.exports = class Client {\n  constructor (opts = {}) {\n    this.opts = opts\n\n    this._reportError = this._reportError.bind(this)\n\n    this._headers = {\n      'Transloadit-Client': this.opts.client\n    }\n  }\n\n  /**\n   * Create a new assembly.\n   *\n   * @param {object} options\n   */\n  createAssembly ({\n    templateId,\n    params,\n    fields,\n    signature,\n    expectedFiles\n  }) {\n    const data = new FormData()\n    data.append('params', typeof params === 'string'\n      ? params\n      : JSON.stringify(params))\n    if (signature) {\n      data.append('signature', signature)\n    }\n\n    Object.keys(fields).forEach((key) => {\n      data.append(key, fields[key])\n    })\n    data.append('num_expected_upload_files', expectedFiles)\n\n    const url = `${this.opts.service}/assemblies`\n    return fetchWithNetworkError(url, {\n      method: 'post',\n      headers: this._headers,\n      body: data\n    })\n      .then((response) => response.json()).then((assembly) => {\n        if (assembly.error) {\n          const error = new Error(assembly.error)\n          error.details = assembly.message\n          error.assembly = assembly\n          if (assembly.assembly_id) {\n            error.details += ' ' + `Assembly ID: ${assembly.assembly_id}`\n          }\n          throw error\n        }\n\n        return assembly\n      })\n      .catch((err) => this._reportError(err, { url, type: 'API_ERROR' }))\n  }\n\n  /**\n   * Reserve resources for a file in an Assembly. Then addFile can be used later.\n   *\n   * @param {object} assembly\n   * @param {UppyFile} file\n   */\n  reserveFile (assembly, file) {\n    const size = encodeURIComponent(file.size)\n    const url = `${assembly.assembly_ssl_url}/reserve_file?size=${size}`\n    return fetchWithNetworkError(url, { method: 'post', headers: this._headers })\n      .then((response) => response.json())\n      .catch((err) => this._reportError(err, { assembly, file, url, type: 'API_ERROR' }))\n  }\n\n  /**\n   * Import a remote file to an Assembly.\n   *\n   * @param {object} assembly\n   * @param {UppyFile} file\n   */\n  addFile (assembly, file) {\n    if (!file.uploadURL) {\n      return Promise.reject(new Error('File does not have an `uploadURL`.'))\n    }\n    const size = encodeURIComponent(file.size)\n    const uploadUrl = encodeURIComponent(file.uploadURL)\n    const filename = encodeURIComponent(file.name)\n    const fieldname = 'file'\n\n    const qs = `size=${size}&filename=${filename}&fieldname=${fieldname}&s3Url=${uploadUrl}`\n    const url = `${assembly.assembly_ssl_url}/add_file?${qs}`\n    return fetchWithNetworkError(url, { method: 'post', headers: this._headers })\n      .then((response) => response.json())\n      .catch((err) => this._reportError(err, { assembly, file, url, type: 'API_ERROR' }))\n  }\n\n  /**\n   * Cancel a running Assembly.\n   *\n   * @param {object} assembly\n   */\n  cancelAssembly (assembly) {\n    const url = assembly.assembly_ssl_url\n    return fetchWithNetworkError(url, { method: 'delete', headers: this._headers })\n      .then((response) => response.json())\n      .catch((err) => this._reportError(err, { url, type: 'API_ERROR' }))\n  }\n\n  /**\n   * Get the current status for an assembly.\n   *\n   * @param {string} url The status endpoint of the assembly.\n   */\n  getAssemblyStatus (url) {\n    return fetchWithNetworkError(url, { headers: this._headers })\n      .then((response) => response.json())\n      .catch((err) => this._reportError(err, { url, type: 'STATUS_ERROR' }))\n  }\n\n  submitError (err, { endpoint, instance, assembly }) {\n    const message = err.details\n      ? `${err.message} (${err.details})`\n      : err.message\n\n    return fetchWithNetworkError('https://transloaditstatus.com/client_error', {\n      method: 'post',\n      body: JSON.stringify({\n        endpoint,\n        instance,\n        assembly_id: assembly,\n        agent: typeof navigator !== 'undefined' ? navigator.userAgent : '',\n        client: this.opts.client,\n        error: message\n      })\n    })\n      .then((response) => response.json())\n  }\n\n  _reportError (err, params) {\n    if (this.opts.errorReporting === false) {\n      throw err\n    }\n\n    const opts = {\n      type: params.type\n    }\n    if (params.assembly) {\n      opts.assembly = params.assembly.assembly_id\n      opts.instance = params.assembly.instance\n    }\n    if (params.url) {\n      opts.endpoint = params.url\n    }\n\n    this.submitError(err, opts).catch((_) => {\n      // not much we can do then is there\n    })\n\n    throw err\n  }\n}\n"]}